<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Process Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* Basic dark theme styling */
body {
    font-family: Arial, sans-serif;
    background: #1a1f2e;
    color: #f1f1f1;
    margin: 0;
}
header {
    background: #2b3145;
    padding: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}
header label { font-weight: bold; }
input, select, button {
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
}
input, select { background: #121622; color: #fff; }
button {
    background: #ff6a5a;
    color: white;
    cursor: pointer;
    font-size: large;
    margin-right: 20px;
    padding: 4px 8px;
    border-radius: 5px;
    border: 1px solid #1a1f2e;
    transition: background 0.2s ease, transform 0.1s ease;
}
button:hover { background: #4ab6e8; }
button:active { transform: scale(0.97); }

.tabs {
    display: flex;
    background: #ff6a5a;
}
.tab {
    padding: 10px 16px;
    cursor: pointer;
    background: #ff6a5a;
    color: #fff;
}
.tab.active { background: #e85a4a; }
.tab-content { padding: 16px; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
}
table th, table td {
    border: 1px solid #444;
    padding: 8px;
    text-align: left;
}
table th { background: #2b3145; }
tr:nth-child(even) { background: #23293d; }

/* Tree view styling */
.tree-node {
    margin-left: 20px;
    border-left: 1px dashed #555;
    padding-left: 8px;
}
.tree-label {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tree-label span {
    font-size: 12px;
    background: #2b3145;
    padding: 2px 6px;
    border-radius: 4px;
}
.tree-toggle {
    width: 14px;
    text-align: center;
    display: inline-block;
    font-weight: bold;
}
</style>
</head>
<body>

<header>
    <!-- Controls for backend URL, hostname, refresh -->
    <label>Backend URL:</label>
    <input id="baseUrl" value="http://127.0.0.1:8000">
    <label>Select Hostname:</label>
    <select id="hostname"></select>
    <button onclick="loadLatest()">Refresh</button>
    <!-- <label><input type="checkbox" id="autoRefresh"> Auto refresh</label> -->
    <label id="update" style="color: #4ae87c;">Loading...</label>
</header>

<!-- Tabs for switching between system and process details -->
<div class="tabs">
    <button id="tabSystem" class="tab active" onclick="showTab('system')">System Details</button>
    <button id="tabProcesses" class="tab" onclick="showTab('processes')">Processes Details</button>
</div>

<!-- System info table -->
<div id="systemTab" class="tab-content">
    <table id="systemTable"></table>
</div>

<!-- Processes tab: switch between table/tree view -->
<div id="processesTab" class="tab-content" style="display:none">
    <div style="margin-bottom:10px;">
        <button onclick="setProcessView('table')">Table View</button>
        <button onclick="setProcessView('tree')">Tree View</button>
    </div>
    <div id="processTableContainer"></div>
</div>

<script>
let allProcesses = []; // stores processes from latest snapshot
let processView = 'table'; // default view mode

// Switches visible tab
function showTab(tab) {
    document.getElementById('systemTab').style.display = tab === 'system' ? 'block' : 'none';
    document.getElementById('processesTab').style.display = tab === 'processes' ? 'block' : 'none';
    document.getElementById('tabSystem').classList.toggle('active', tab === 'system');
    document.getElementById('tabProcesses').classList.toggle('active', tab === 'processes');
}

// Sets process display mode
function setProcessView(view) {
    processView = view;
    renderProcesses();
}

// Loads available hostnames from backend
async function loadHosts() {
    const base = document.getElementById('baseUrl').value.trim();
    try {
        const resp = await fetch(`${base}/api/hosts/`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        const hostSelect = document.getElementById('hostname');
        hostSelect.innerHTML = '';
        data.hosts.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.hostname;
            opt.textContent = h.hostname;
            hostSelect.appendChild(opt);
        });

        // Auto-select first hostname and load its data
        if (data.hosts.length > 0) {
            hostSelect.value = data.hosts[0].hostname;
            loadLatest();
        }
    } catch (err) {
        alert("Error loading hosts: " + err.message);
    }
}

// Loads latest snapshot for selected hostname
async function loadLatest() {
    const base = document.getElementById('baseUrl').value.trim();
    const hn = document.getElementById('hostname').value;
    if (!hn) { alert("Select hostname"); return; }

    try {
        const resp = await fetch(`${base}/api/latest?hostname=${encodeURIComponent(hn)}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // Render system details
        const sys = data.system_info || {};
        const sysHTML = `
            <tr><th>Name</th><td>${sys.name || ''}</td></tr>
            <tr><th>Operating System</th><td>${sys.os || ''}</td></tr>
            <tr><th>Processor</th><td>${sys.processor || ''}</td></tr>
            <tr><th>Number of Cores</th><td>${sys.cores || ''}</td></tr>
            <tr><th>Number of Threads</th><td>${sys.threads || ''}</td></tr>
            <tr><th>RAM (GB)</th><td>${sys.ram_gb || ''}</td></tr>
            <tr><th>Used RAM (GB)</th><td>${sys.used_ram_gb || ''}</td></tr>
            <tr><th>Available RAM (GB)</th><td>${sys.available_ram_gb || ''}</td></tr>
            <tr><th>Storage Free (GB)</th><td>${sys.storage_free_gb || ''}</td></tr>
            <tr><th>Storage Total (GB)</th><td>${sys.storage_total_gb || ''}</td></tr>
            <tr><th>Storage Used (GB)</th><td>${sys.storage_used_gb || ''}</td></tr>
        `;
        document.getElementById('systemTable').innerHTML = sysHTML;

        // Store process list
        allProcesses = data.snapshot.processes || [];

        // Show last update time
        const date = new Date(data.snapshot.created_at);
        document.getElementById("update").textContent = ` Updated at ${date.toLocaleString()}`;
        renderProcesses();
    } catch (err) {
        alert("Error loading data of user: " + err.message);
    }
}

// Renders processes in table or tree view
function renderProcesses() {
    const container = document.getElementById('processTableContainer');
    container.innerHTML = '';

    if (processView === 'table') {
        // Table layout
        let html = `<table><tr>
            <th>Sr. No</th>
            <th>Name</th>
            <th>Memory Usage (MB)</th>
            <th>CPU Usage (%)</th>
            <th>PPID</th>
        </tr>`;
        let i = 1;
        allProcesses.forEach(p => {
            html += `<tr>
                <td>${i}</td>
                <td>${p.name}</td>
                <td>${p.memory_mb ?? ''}</td>
                <td>${p.cpu_percent ?? ''}</td>
                <td>${p.ppid ?? ''}</td>
            </tr>`;
            i++;
        });
        html += '</table>';
        container.innerHTML = html;
    } else {
        // Tree layout
        const byPid = new Map();
        const roots = [];
        allProcesses.forEach(p => { p.children = []; byPid.set(p.pid, p); });
        allProcesses.forEach(p => {
            if (p.ppid && byPid.has(p.ppid)) byPid.get(p.ppid).children.push(p);
            else roots.push(p);
        });
        const treeEl = document.createElement('div');
        roots.forEach(r => treeEl.appendChild(renderTreeNode(r)));
        container.appendChild(treeEl);
    }
}

// Creates a recursive tree node for process hierarchy
function renderTreeNode(proc) {
    const wrapper = document.createElement('div');
    wrapper.className = 'tree-node';

    const label = document.createElement('div');
    label.className = 'tree-label';
    const toggle = document.createElement('span');
    toggle.className = 'tree-toggle';
    toggle.textContent = proc.children && proc.children.length > 0 ? '▼' : '';
    label.prepend(toggle);
    label.innerHTML += `<b>${proc.name}</b> (PID: ${proc.pid}) 
        <span>CPU: ${proc.cpu_percent ?? ''}%</span>
        <span>Mem: ${proc.memory_mb ?? ''} MB</span>`;
    wrapper.appendChild(label);

    // Handle collapsible children
    if (proc.children && proc.children.length > 0) {
        let expanded = true;
        const childrenContainer = document.createElement('div');
        proc.children.forEach(c => childrenContainer.appendChild(renderTreeNode(c)));
        wrapper.appendChild(childrenContainer);

        label.addEventListener('click', () => {
            expanded = !expanded;
            childrenContainer.style.display = expanded ? 'block' : 'none';
            toggle.textContent = expanded ? '▼' : '▶';
        });
    }
    return wrapper;
}



// Fetch host list on page load
document.addEventListener('DOMContentLoaded', loadHosts);
</script>
</body>
</html>
